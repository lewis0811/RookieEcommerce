@using System.Globalization
@model RookieEcommerce.CustomerSite.Models.HomeProductDetailsViewModel

@{
    ViewData["Title"] = Model.ProductDetails.Name;
    var productDetails = Model.ProductDetails;
    var productRatings = Model.ProductRatings;
    var createModel = Model.CreateProductRating;
    createModel.ProductId = productDetails.Id;
    createModel.CustomerId = productRatings.Items[0].CustomerId; // Change to get from cookie later
}

<div class="container mt-5">
    <div class="row mb-3">
        @* Left col: Product images*@
        <div class="col-md-6">
            @if (productDetails.Images != null && productDetails.Images.Any())
            {
                @* Show first image to be base image *@
                <img src="@productDetails.Images.FirstOrDefault()?.ImageUrl" class="img-fluid rounded" alt="@productDetails.Name" width="500" height="500" />

                <div class="row mt-3">
                    @foreach (var image in productDetails.Images.OrderBy(c => c.SortOrder))
                    {
                        <div class="col-3 col-md-2 mb-3">
                            <img src="@image.ImageUrl" class="img-thumbnail" alt="Product thumbnail" style="cursor: pointer;" />
                        </div>
                    }
                </div>
            }
            else
            {
                <img src="https://via.placeholder.com/500x500?text=No+Image" class="img-fluid rounded" alt="@productDetails.Name" />
            }
        </div>

        @* LEFT COL: PRODUCT DETAILS*@
        <div class="col-md-6">
            <h3 class="mb-3">@productDetails.Name</h3>

            @* Product price *@
            <div class="mb-3">
                <h3>
                    <span style="color: #ffac4b; font-size: 30px; font-weight: 900">
                        @productDetails.Price.ToString("C", new CultureInfo("vi-VN"))
                    </span>
                </h3>
            </div>

            <hr/>

            @* Categories *@
            @if (productDetails.Category != null)
            {
                <p class="text-muted">Danh mục: @productDetails.Category.Name</p>
            }

            @* Description *@
            <div class="mb-3">
                <h5>Mô tả:</h5>
                <p class="form-text">@productDetails.Description</p>
            </div>

            @* Product varians*@
            @if (productDetails.Variants != null && productDetails.Variants.Any())
            {
                var variantGroups = productDetails.Variants.GroupBy(c => c.VariantType);

                foreach(var group in variantGroups)
                {
                    <div class="mb-4 row">
                        <fieldset class="col-auto fs-1">
                            <legend class="btn-group col-form-label fs-6 px-1 align-items-center fw-bold ">
                                @group.Key
                                @foreach(var item in group)
                                {
                                    <input type="radio" class="btn-check" name="@group.Key" id="@item.Id" autocomplete="off" checked>
                                    <label class="btn btn-outline-secondary" for="@item.Id">
                                        @item.Name
                                    </label>
                                }
                            </legend>
                        </fieldset>
                    </div>
                }
            }

            @* Amount *@
            <div class="mb-3 fw-bold row align-items-center">
                <div class="col-auto">Số lượng</div>
                <div class="input-group col-auto" style="width: 150px;">
                    <button class="btn btn-outline-secondary btn-minus" type="button">-</button>
                    <input type="number" class="form-control text-center" id="qtym" name="quantity" min="1" value="1" maxlength="3">
                    <button class="btn btn-outline-secondary btn-plus" type="button">+</button>
                </div>
            </div>

            @* Add to cart *@
            <div class="mt-4">
                <button class="btn fs-4 fw-bold" style="background-color: #ffac4b">
                    <i class="bi bi-cart4"></i>
                    Thêm vào giỏ hàng
                </button>
            </div>

        </div>
    </div>

    @* Product details *@
    <nav class="text-center">
        <div class="nav nav-tabs justify-content-center" id="nav-tab" role="tablist">
            <button class="nav-link active text-black-50 fw-bold" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">THÔNG TIN SẢN PHẨM</button>
            <button class="nav-link text-black-50 fw-bold" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">ĐÁNH GIÁ</button>
        </div>

        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                @if (!string.IsNullOrEmpty(productDetails.Details))
                {
                    <div class="mb-3">@Html.Raw(productDetails.Details)</div>
                }

                else
                {
                    <div id="details" class="tab-pane fade in active">
                        <p>Chưa có thông tin sản phẩm</p>
                    </div>
                }
            </div>

            @* Product rating *@
            <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
                <div class="container py-4">
                    
                    @* Total rating - Refined *@
                    <div class="d-flex align-items-center mb-4 justify-content-center">
                        <span class="text-warning h4 mb-0 me-2">⭐</span>
                        <span class="h4 mb-0 me-2">@productRatings.Items.Select(c => c.RatingValue).Average() /5</span>
                        <span class="text-muted mb-0">(@productRatings.Items.Count đánh giá)</span>
                    </div>

                    @* Customer rating *@
                    <div class="row ">
                        <div class="col-md-8">
                            <h4 class="text-center">Đánh giá của khách</h4>
                            @foreach (var item in productRatings.Items)
                            {
                                <div class="border-bottom pb-2 mb-3 mt-3">
                                    <div class="d-flex align-items-center mb-1">
                                        <strong class="me-auto">@item.Customer!.FirstName @item.Customer.LastName</strong>
                                        <small class="text-muted">@item.CreatedDate</small>
                                    </div>
                                    <div class="text-warning text-center">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= item.RatingValue)
                                            {
                                                <i class="bi bi-star-fill"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-star"></i>
                                            }
                                        }
                                    </div>
                                    <p class="mb-0 text-center">@item.Comment</p>
                                </div>
                            }
                        </div>

                        @* Rating form *@
                        <div class="col-md-4 border-start">
                            <form asp-controller="Products" asp-action="Rating" method="post" >
                                <h4 class="text-center">Viết đánh giá của bạn</h4>
                                    <div class="mb-3">
                                        <p class="form-label">Đánh giá</p>
                                        <div class="star-rating animated-stars">
                                            <input asp-for=CreateProductRating.CustomerId value=@createModel.CustomerId hidden/>
                                            <input asp-for=CreateProductRating.ProductId value=@createModel.ProductId hidden />

                                            <input type="radio" id="star5" asp-for=CreateProductRating.RatingValue value="5">
                                            <label for="star5" class="bi bi-star-fill"><span hidden>5</span></label>
                                            <input type="radio" id="star4" asp-for=CreateProductRating.RatingValue value="4">
                                            <label for="star4" class="bi bi-star-fill"><span hidden>4</span></label>
                                            <input type="radio" id="star3" asp-for=CreateProductRating.RatingValue value="3">
                                            <label for="star3" class="bi bi-star-fill"><span hidden>3</span></label>
                                            <input type="radio" id="star2" asp-for=CreateProductRating.RatingValue value="2">
                                            <label for="star2" class="bi bi-star-fill"><span hidden>2</span></label>
                                            <input type="radio" id="star1" asp-for=CreateProductRating.RatingValue value="1">
                                            <label for="star1" class="bi bi-star-fill"><span hidden>1</span></label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nội dung đánh giá
                                            <textarea asp-for=CreateProductRating.Comment class="form-control" rows="4" required></textarea>
                                        </label>
                                    </div>
                                <button type="submit" class="btn btn-primary mt-2">Gửi đánh giá</button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </nav>
</div>

@section Scripts {
    @* Product detail image script *@
    <script>
        const placeholderImageUrl = "https://dummyimage.com/500x500/55595c/fff";
        
        document.querySelectorAll('.img-thumbnail').forEach(img => {
            img.addEventListener('error', function() {
                this.src = placeholderImageUrl;
                this.alt = 'Image not available';
            });
            img.addEventListener('click', function() {
                document.querySelector('.col-md-6 img.rounded').src = this.src;
            });
        });
    </script>

    @* Number input spinner *@
    <script>
        $(function() {
            const $quantityInput = $('#qtym');
            const $btnMinus = $('.btn-minus');
            const $btnPlus = $('.btn-plus');

            $btnMinus.on('click', function() {
                if ($quantityInput.length) {
                    $quantityInput[0].stepDown();
                }
            });

            $btnPlus.on('click', function() {
                 if ($quantityInput.length) {
                     $quantityInput[0].stepUp();
                 }
            });
        });
    </script>

    @* Product star rating script *@
    <script>
        document.querySelectorAll('.star-rating:not(.readonly) label').forEach(star => {
            star.addEventListener('click', function() {
                this.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
            });
        });
    </script>
}